#!/bin/sh
# meraki's only have /bin/sh, this is going to get painful.

BINDIR=/usr/sbin
CONFDIR=/storage/netmangler/conf
STATEDIR=/var/run/netmangler
LIBDIR=/usr/lib/netmangler
DEFAULTCONFDIR=/usr/etc/netmangler/defaults

MODULES="route firewall wpa display feature"

mkdir $STATEDIR -p

for i in $MODULES; do
	. $LIBDIR/plugin-$i.sh
	init_$i
done
echo

iftype() {
	if [ ! -r $LIBDIR/iftype-$1.sh ]; then
		echo $IFNAME: Unknown interface type $1
		exit 1
	else
		. $LIBDIR/iftype-$1.sh 
		ONCOMPLETE="$ONCOMPLETE iftype_$1"
	fi
}

addressing() {
	if [ ! -r $LIBDIR/addressing-$1.sh ]; then
		echo $IFNAME: Unknown addressing type $1
		exit 1
	else
		. $LIBDIR/addressing-$1.sh 
		ONCOMPLETE="$ONCOMPLETE addressing_$1"
	fi
}

parentif() {
	PARENTIFS="$PARENTIFS $1"
	configureif $1
	echo deconfigureif $IFNAME >>$STATEDIR/$1.deps
}

deconfigureif() {
	if [ -f $STATEDIR/$1.if ]; then
		if [ -f $STATEDIR/$1.deps ]; then
			. $STATEDIR/$1.deps
			rm -f $STATEDIR/$1.deps
		fi
		echo $1: Deconfiguring $1
		(
			IFNAME=$1
			. $STATEDIR/$1.if 
		)
		rm -f $STATEDIR/$1.if
	fi
}

configureif() {
	(
		IFNAME=$1
		unset ONCOMPLETE
		unset PARENTIFS
		CLEANUP_CMDS=true

		if [ ! -f $STATEDIR/$IFNAME.if -o $CONFDIR/$1.if -nt $STATEDIR/$IFNAME.if -o $BINDIR/netmangler -nt $STATEDIR/$1.if ]
		then
			deconfigureif $IFNAME
			for i in $MODULES; do
				newif_$i
			done
			. $CONFDIR/$IFNAME.if
			for i in $ONCOMPLETE; do
				$i
			done
			for i in $MODULES; do
				do_$i
			done
			echo $IFNAME: cleanup cmds: $CLEANUP_CMDS
			echo
			touch $CONFDIR/$IFNAME.if #Perry says this is nasty. If it breaks, blame him.
			echo $CLEANUP_CMDS > $STATEDIR/$IFNAME.if
		else
			echo $IFNAME: Skipping configured $1
		fi
	) || true
}

	
setdefaults() {
	
	echo "Configuration dir '$CONFDIR' didn't exist, setting defaults"
	
	mkdir -p $CONFDIR
	
	cp $DEFAULTCONFDIR/* $CONFDIR/	
	
	makeint
	
	echo "Done!"
	
}

makeint() {
	MAC=`ip -o link | grep -E "(eth0|int)" | sed 's/.*link\/ether \([0-9:a-f]*\).*/\1/g'` 
	
	echo "Making default int.if for MAC $MAC"

	#make the int.if
	echo "displayoptions nmbase" > $CONFDIR/int.if
	echo "iftype ethernet" >> $CONFDIR/int.if
	echo -n "mac " >> $CONFDIR/int.if
	echo $MAC >> $CONFDIR/int.if
	echo "addressing static" >> $CONFDIR/int.if
	echo "address 192.168.1.254/24" >> $CONFDIR/int.if
}

setdefaultdns() {
	
	echo "DNSMASQ config didn't exist, setting default"
	
	cp $DEFAULTCONFDIR/dnsmasq.conf /storage/
}

#restore default configs if we need to
if [ ! -f $CONFDIR/int.if ]; then
	setdefaults
fi

if [ ! -f /storage/dnsmasq.conf ]; then
	setdefaultdns
fi

for i in $CONFDIR/*.if; do
	configureif $(basename ${i%.if})
done

for i in $STATEDIR/*.if; do
	(
		IFNAME=$(basename ${i%.if})
		if [ ! -f $CONFDIR/$IFNAME.if ]; then
			echo $IFNAME: Deconfiguring $IFNAME
			deconfigureif $IFNAME
		fi
	)
done

