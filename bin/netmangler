#!/bin/sh
# meraki's only have /bin/sh, this is going to get painful.

BINDIR=/usr/sbin
STATEDIR=/var/run/netmangler
LIBDIR=/usr/lib/netmangler
LOCALCONFIG=/etc/netmangler/netmangler.conf

if [ -r "$LOCALCONFIG" ]; then
	. $LOCALCONFIG
fi

if [ -z "$CONFDIR" ]; then
	CONFDIR=/etc/netmangler/conf
fi

if [ -z "$DEFAULTCONFDIR" ]; then
	DEFAULTCONFDIR=/usr/share/netmangler/defaults
fi

MAC=`ip -o link | grep -E "(eth0|int)" | sed 's/.*link\/ether \([0-9:a-f]*\).*/\1/g'` 

MODULES="route firewall wpa display feature iwpriv"

mkdir $STATEDIR -p

for i in $MODULES; do
	. $LIBDIR/plugin-$i.sh
	init_$i
done
echo

iftype() {
	if [ ! -r $LIBDIR/iftype-$1.sh ]; then
		echo $IFNAME: Unknown interface type $1
		exit 1
	else
		. $LIBDIR/iftype-$1.sh 
		ONCOMPLETE="$ONCOMPLETE iftype_$1"
	fi
}

addressing() {
	if [ ! -r $LIBDIR/addressing-$1.sh ]; then
		echo $IFNAME: Unknown addressing type $1
		exit 1
	else
		. $LIBDIR/addressing-$1.sh 
		ONCOMPLETE="$ONCOMPLETE addressing_$1"
	fi
}

parentif() {
	PARENTIFS="$PARENTIFS $1"
	configureif $1
	echo deconfigureif $IFNAME >>$STATEDIR/$1.deps
}

deconfigureif() {
	if [ -f $STATEDIR/$1.if ]; then
		if [ -f $STATEDIR/$1.deps ]; then
			. $STATEDIR/$1.deps
			rm -f $STATEDIR/$1.deps
		fi
		echo $1: Deconfiguring $1
		(
			IFNAME=$1
			. $STATEDIR/$1.if 
		)
		rm -f $STATEDIR/$1.if
	fi
}

configureif() {
	(
		IFNAME=$1
		unset ONCOMPLETE
		unset PARENTIFS
		CLEANUP_CMDS=true

		if [ ! -f $STATEDIR/$IFNAME.if -o $CONFDIR/$1.if -nt $STATEDIR/$IFNAME.if -o $BINDIR/netmangler -nt $STATEDIR/$1.if ]
		then
			deconfigureif $IFNAME
			for i in $MODULES; do
				newif_$i
			done
			. $CONFDIR/$IFNAME.if
			for i in $ONCOMPLETE; do
				$i
			done
			for i in $MODULES; do
				do_$i
			done
			echo $IFNAME: cleanup cmds: $CLEANUP_CMDS
			echo
			touch $CONFDIR/$IFNAME.if #Perry says this is nasty. If it breaks, blame him.
			echo $CLEANUP_CMDS > $STATEDIR/$IFNAME.if
		else
			echo $IFNAME: Skipping configured $1
		fi
	) || true
}

	
setdefaults() {
	
	mkdir -p $CONFDIR
	
	cp $DEFAULTCONFDIR/*.if $CONFDIR/	
	
	sed $DEFAULTCONFDIR/eth0.if.template -e "s/MAC/$MAC/" > $CONFDIR/eth0.if
	sed $DEFAULTCONFDIR/int.if.template -e "s/MAC/$MAC/" > $CONFDIR/int.if
	
	cp $DEFAULTCONFDIR/dnsmasq.conf /storage/
	
	echo "Done!"
	
}

makeint() {
	MAC=`ip -o link | grep -E "(eth0|int)" | sed 's/.*link\/ether \([0-9:a-f]*\).*/\1/g'` 
	
	#CPE only!
	cp $DEFAULTCONFDIR/dnsmasq.conf /storage/
}


#restore default configs if we need to
if [ ! -d $CONFDIR ]; then
	echo "Configuration dir '$CONFDIR' didn't exist, setting defaults"
	setdefaults
fi

if [ $(ls -1a $CONFDIR/*.if | wc -l) -eq 0 ]; then
	echo "Configuration dir '$CONFDIR' was empty, setting defaults"
	setdefaults
fi

for i in $CONFDIR/*.if; do
	configureif $(basename ${i%.if})
done

for i in $STATEDIR/*.if; do
	(
		IFNAME=$(basename ${i%.if})
		if [ ! -f $CONFDIR/$IFNAME.if ]; then
			echo $IFNAME: Deconfiguring $IFNAME
			deconfigureif $IFNAME
		fi
	)
done

